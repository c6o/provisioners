apiVersion: system.codezero.io/v1
kind: App
metadata:
  name: istio
  namespace: istio-system
  annotations:
    system.codezero.io/display: Istio
    system.codezero.io/iconUrl: '{{hubServerURL}}/api/assets/apps/istio/icon'
spec:
  navstation: true
status: Running
---

apiVersion: security.istio.io/v1beta1
kind: "RequestAuthentication"
metadata:
  name: ingress
  namespace: istio-system
spec:
  selector:
    matchLabels:
      app: istio-ingressgateway
  jwtRules:
    - outputPayloadToHeader: c6o-token
      issuer: "codezero-technologies-inc" # no spaces nor caps allowed; otherwise Istio will throw and auth errro
      jwks: |
        {
          keys: [
            {
              "kty": "oct",
              "use": "sig",
              "kid": "codezero-technologies-inc",
              "k": "{{encodedJwtKey}}",
              "alg": "HS256"
            }
          ]
        }
---

apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: ingress
 namespace: istio-system
spec:
 selector:
   matchLabels:
     app: istio-ingressgateway
 action: ALLOW
 rules:
 - to: # this is for the main cluster; otherwise marina, navstation and store wouldn't work
   - operation:
       methods: ["*"]
       hosts: ["{{host}}"]